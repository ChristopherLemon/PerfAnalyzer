{% extends "base.html" %}
{% block layouttitle %}
{{trace_model.layout.title}}
<br>
<br>
<div id="flamegraph_reference_case" class="flex-column" style="border-style:none;width:100%;height:100%">Reference Process ID: {{trace_model.layout.reference_id}}</div>
{% endblock %}
{% block content %}

<div class="panel-group" id="accordion">
    <div class="container">
        <div class="row">
            <div class="flex-column" style="border-style:none;width:100%;height:100%">
                <div class="panel panel-default">
                    <a data-toggle="collapse" data-parent="#accordion" href="#flamegraph_collapse">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <strong>FlameGraph (Time Ordered Event Samples)</strong><i class="indicator glyphicon glyphicon-chevron-left  pull-right"></i>
                            </h4>
                        </div>
                    </a>
                    <div id="flamegraph_collapse" class="panel-collapse collapse">
                        <div class="flex-row">
                            <div class="flex-column" style="border-style:none;width:100%;height:100%"><div class="loader" id="flamegraph_loader" hidden style="font-size:20px;color:RoyalBlue;margin-left:12px;"></div></div>
                        </div>
                        <div class="flex-column" style="width:100%;height:100%;text-align:center">
                            <label style="font-size:20px;" id="time_range"></label>
                        </div>
                        <div class="flex-row" style="margin-left:0">
                            <div class="flex-column" style="width:20%;height:100%;">
                                <div id="prev_button" class="btn-group" data-toggle="buttons">
                                    <label style="margin:1px;margin-left:12px" class="btn btn-primary" onclick="find_function('prev')">
                                        <input type="radio" autocomplete="off"> Prev
                                    </label>
                                </div>
                            </div>
                            <div class="flex-column" style="width:60%;height:100%;text-align:center">
                                <label style="font-size:20px;" id="flamegraph_info"></label>
                            </div>
                            <div class="flex-column" style="width:20%;height:100%;">
                                <div id="next_button" class="btn-group pull-right" data-toggle="buttons">
                                    <label style="margin:1px;margin-right:12px" class="btn btn-primary pull-right" onclick="find_function('next')">
                                        <input type="radio" autocomplete="off"> Next
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="row" style="margin-left:0">
                            <div class="flex-column" style="width:100%;height:100%">
                                <object class="embedded_svg" type="image/svg+xml" data={{trace_model.layout.flamegraph}} id="flamegraph" onload="add_flamegraph_events()"></object>
                            </div>
                        </div>
                        <div class="flex-row" style=";margin-left:0;margin-right:0">
                            <div class="flex-column" style="width:60%;height:100%;">
                                <div class="btn-group" data-toggle="buttons" >
                                    <label id="cumulative_button" style="margin:1px;margin-left:12px;" class="btn btn-primary active" onclick="toggle_flamegraph_mode('cumulative')">
                                        <input  type="radio" autocomplete="off" checked> Cumulative
                                    </label>
                                    <label id="trace_button" style="margin:1px;" class="btn btn-primary" onclick="toggle_flamegraph_mode('trace')">
                                        <input type="radio" autocomplete="off"> Trace
                                    </label>
                                </div>
                            </div>
                            <p>Text Filter:</p>
                            <div class="flex-row" style="border-style:none;">
                                <div class="flex-column" style="width:100%"><input style="margin:1px" class="form-control" id="text_filter" name="text_filter" placeholder="Regular Expression (i.e. match function1 or function2 with function1|function2)" value="" oninput="find_text(this,'flamegraph')"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <form action="" method="post" id="event_form">
        <div class="container">
            <div class="row">
                <div class="flex-column" style="border-style:none;width:100%;height:100%">
                    <div class="panel panel-default">
                        <a data-toggle="collapse" data-parent="#accordion" href="#event_totals_chart_collapse">
                            <div class="panel-heading">
                                <h4 class="panel-title">
                                    <strong>Process Traces</strong><i class="indicator glyphicon glyphicon-chevron-left  pull-right"></i>
                                </h4>
                            </div>
                        </a>
                        <div id="event_totals_chart_collapse" class="panel-collapse collapse">
                            <div class="flex-row">
                                <div class="flex-column" style="border-style:none;width:100%;height:100%"><div class="loader" id="chart_loader" hidden style="font-size:20px;color:RoyalBlue;margin-left:12px;"></div></div>
                            </div>
                            <div class="btn-group chart_controls" data-toggle="buttons" >
                                <label style="margin:1px;margin-left:12px;" class="btn btn-primary active" onclick="toggle_selection_mode('add-remove-process')">
                                    <input type="radio"  autocomplete="off" checked> Add / Remove Process
                                </label>
                                <label style="margin:1px;" class="btn btn-primary" onclick="toggle_selection_mode('zoom')">
                                    <input type="radio" autocomplete="off"> Zoom
                                </label>
                            </div>
                            <div id="canvas_container" class="svg_canvas_container">
                                <div style="margin-right:12px;" class="pull-right chart_controls"><i style="color:grey;font-size:18px;"><span id="selection_mode_text">Click on a process or select a range to update flamegraph</span></i></div>
                                <object class="embedded_svg svg_underlay" type="image/svg+xml" data={{trace_model.layout.timelines}} id="timelines" onload="add_timeline_events('timelines')"></object>
                                <div id="dynamic_div" style="position:absolute;width:100%;height:100%;top:0;left:0;bottom:0;right:0;pointer-events:none;">
                                    <svg width="100%" height="100%">
                                        <rect id="dynamic_rectangle" x="0" y="0" width="0" height="0" style="fill:blue;stroke:#337ab7;stroke-width:3;fill-opacity:0.1;stroke-opacity:0.9;"></rect>
                                    </svg>
                                </div>
                            </div>
                            <div id="reset_timelines_button" class="btn-group pull-right" data-toggle="buttons">
                                <label style="margin:1px;margin-right:12px" class="btn btn-primary" onclick="reset_timelines()">
                                    <input type="radio" autocomplete="off"> Reset
                                </label>
                            </div>
                            <div class="flex-row" style="border-style:none;">
                                <div class="flex-column" style="width:100%"><p>Text Filter:</p><input style="margin:1px" class="form-control" id="text_filter2" name="text_filter2" placeholder="Regular Expression (i.e. match function1 or function2 with function1|function2)" value="" oninput="find_text(this,'timelines')"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <form action="" method="post" >
        <input type="hidden" id="reference_id" name="reference_id" value={{trace_model.reference_id}} />
        <input type="hidden" id="reference_count" name="reference_count" value={{trace_model.reference_count}} />
        <div class="container">
            <div class="row">
                <div class="flex-column" style="border-style:none;width:100%;height:100%">
                    <div class="panel panel-default">
                        <a data-toggle="collapse" data-parent="#accordion" href="#event_process_list_collapse">
                            <div class="panel-heading">
                                <h4 class="panel-title">
                                    <strong>Select Processes / Threads</strong><i class="indicator glyphicon glyphicon-chevron-left  pull-right"></i>
                                </h4>
                            </div>
                        </a>
                        {% if trace_model.system_wide %}
                            {% set unit = "Core" %}
                            {% set units = "Cores" %}
                        {% else %}
                            {% set unit = "Process" %}
                            {% set units = "Processes" %}
                        {% endif %}
                        <div id="event_process_list_collapse" class="panel-collapse collapse">
                            <div class="flex-row">
                                <div class="flex-column" style="border-style:none;width:100%;height:100%"><div class="loader" id="process_loader" hidden style="font-size:20px;color:RoyalBlue;margin-left:12px;"></div></div>
                            </div>
                            <div class="flex-row" style="border-style:none;">
                                <div class="flex-column" style="width:55%"><p>Filter background processes (%)</p><input style="margin:1px" type="number" class="form-control" id="process_filter" name="process_filter" placeholder="Percentage of total" min="0" max="{{100}}" step="0.1" value="0.0" oninput="filter_threads(this)"></div>
                            </div>
                            <div class="flex-column" style="border-style:none;width:100%;height:100%">
                                <div class="flex-row" style="margin-left:0">
                                    <p>Thread Event Counts</p>
                                </div>
                                <div class="flex-row" style="margin-left:0">
                                    <label><input type="checkbox" onclick="check_thread_boxes(this,'')" class="thread_checkbox" id="check_all_threads" name="check_all_threads"><b>Select Thread Event Counts For All Jobs</b></label>
                                </div>
                                {% for job in trace_model.jobs %}
                                    <div class="counted_checklist">
                                        <div class="flex-row" style="margin-left:0">
                                            <div class="flex-column" style="width:30%;height:100%"><a type="button" class="btn btn-info collapsed collapsible_btn" data-toggle="collapse" data-target="#{{job}}_process_list">Select Thread Event Counts For Job {{job}} <span class="checkboxcount"></span><span class="fa chevron pull-right"></span></a></div>
                                            <div class="flex-column" style="width:25%;height:100%"><label><input type="checkbox" onclick="check_thread_boxes(this,'{{job}}_')" class="thread_checkbox" id="check_all_threads_{{job}}" name="check_all_threads_{{job}}"><b>Select Thread Event Counts For All {{units}}</b></label></div>
                                            <div class="flex-column" style="width:20%;height:100%"><span class="gradient_bar sum_checkbox_percentages"></span></div>
                                            <div class="flex-column" style="width:25%;height:100%"><span style="font-weight:bold" class="dynamic_text sum_checkbox_percentages"></span></div>
                                        </div>
                                        <div id={{job}}_process_list class="collapse">
                                            {% for process_name in trace_model.process_names[job]|natural_sort %}
                                                {% if "all" not in process_name %}
                                                    <div class="counted_checklist">
                                                        <div class="flex-row" style="margin-left:0">
                                                            <div class="flex-column" style="width:45%;height:100%"><a type="button" class="btn btn-info collapsed collapsible_btn" data-toggle="collapse" data-target="#{{job}}_{{process_name}}_thread_list">Select Thread Event Counts For {{unit}} {{process_name}} <span class="checkboxcount"></span><span class="fa chevron pull-right"></span></a></div>
                                                            <div class="flex-column" style="width:15%;height:100%"><label><input type="checkbox" onclick="check_thread_boxes(this,'{{job}}_{{process_name}}_')" class="thread_checkbox" id="check_thread_box_{{job}}_{{process_name}}" name="check_thread_box_{{job}}_{{process_name}}"><b>Select All Threads</b></label></div>
                                                            <div class="flex-column" style="width:20%;height:100%"><span class="gradient_bar sum_checkbox_percentages"></span></div>
                                                            <div class="flex-column" style="width:20%;height:100%"><span style="font-weight:bold" class="dynamic_text sum_checkbox_percentages"></span></div>
                                                        </div>
                                                        <div id={{job}}_{{process_name}}_thread_list class="collapse">
                                                            {% for id in ids %}
                                                                {% if id.job == job and id.process_name == process_name and id.tid != "all" %}
                                                                    {% if id in trace_model.selected_ids %}
                                                                        {% set checked = "checked" %}
                                                                    {% else %}
                                                                        {% set checked = "" %}
                                                                    {% endif %}
                                                                    <div class="flex-row thread_filter" style="margin-left:0">
                                                                        <div class="flex-column" style="width:65%;height:100%"><label><input class="thread_checkbox counted_checkbox" type="checkbox" {{checked}} id="{{job}}_{{process_name}}_{{id.tid}}" name="{{id.label}}"><b>Event Count For Thread:&nbsp{{id.tid}}</b></label></div>
                                                                        <div class="flex-column" style="width:20%;height:100%"><span class="gradient_bar" value="{{id.max_percentage}}"></span></div>
                                                                        <div class="flex-column" style="width:15%;height:100%"><span style="font-weight:bold" class="summed_percentage" value="{{id.total_percentage}}"></span><strong style="margin-left:6px;">{{id.total_percentage|round(2)|format_percentage}} %</strong></div>
                                                                    </div>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            {% if trace_model.system_wide %}
                            <div class="flex-column" style="border-style:none;width:100%;height:100%">
                                <div class="flex-row" style="margin-left:0">
                                    <p>Core Cumulative Event Counts (Summed Over Threads)</p>
                                </div>
                                <div class="flex-row" style="margin-left:0">
                                    <label><input type="checkbox" onclick="check_process_boxes(this,'')" class="process_checkbox" id="check_all_processes" name="check_all_processes"><b>Select {{unit}} Event Counts For All Jobs</b></label>
                                </div>
                                {% for job in trace_model.jobs %}
                                    <div class="counted_checklist">
                                        <div class="flex-row" style="margin-left:0">
                                            <div class="flex-column" style="width:30%;height:100%"><a type="button" class="btn btn-info collapsed collapsible_btn" data-toggle="collapse" style="padding-left:0%width:25%" data-target="#{{job}}_process_list2">Select {{unit}} Event Counts for Job {{job}} </span><span class="checkboxcount"></span><span class="fa chevron pull-right"></span></a></div>
                                            <div class="flex-column" style="width:25%;height:100%"><label><input type="checkbox" onclick="check_process_boxes(this,'{{job}}_')" class="process_checkbox" id="check_all_processes_{{job}}" name="check_all_processes_{{job}}"><b>Select {{unit}} Event Counts For All Processes</b></label></div>
                                            <div class="flex-column" style="width:20%;height:100%"><span class="gradient_bar sum_checkbox_percentages"></span></div>
                                            <div class="flex-column" style="width:25%;height:100%"><span style="font-weight:bold" class="dynamic_text sum_checkbox_percentages"></span></div>
                                        </div>
                                        <div id={{job}}_process_list2 class="collapse">
                                            {% for process_name in trace_model.process_names[job]|natural_sort %}
                                                {% for id in ids %}
                                                    {% if id.job == job and id.process_name == process_name and id.pid != "all" and id.tid == "all" %}
                                                        {% if id in trace_model.selected_ids %}
                                                            {% set checked = "checked" %}
                                                        {% else %}
                                                            {% set checked = "" %}
                                                        {% endif %}
                                                        <div class="flex-row thread_filter" style="margin-left:0">
                                                            <div class="flex-column" style="width:60%;height:100%"><label><input class="process_checkbox counted_checkbox" type="checkbox" {{checked}} id="{{job}}_{{process_name}}_all" name="{{id.label}}"><b>Event Count For {{unit}}:&nbsp{{id.process_name}}</b></label></div>
                                                            <div class="flex-column" style="width:20%;height:100%"><span class="gradient_bar" value="{{id.max_percentage}}"></span></div>
                                                            <div class="flex-column" style="width:15%;height:100%"><span style="font-weight:bold" class="summed_percentage" value="{{id.total_percentage}}"></span><strong style="margin-left:6px;">{{id.total_percentage|round(2)|format_percentage}} %</strong></div>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="flex-column" style="border-style:none;width:100%;height:100%">
                                <div class="flex-row" style="margin-left:0">
                                    <p>Host Cumulative Event Counts (Summed Over Cores)</p>
                                </div>
                                <div class="flex-row" style="margin-left:0">
                                    <label><input type="checkbox" onclick="check_job_boxes(this,'')" class="job_checkbox" id="check_all_jobs" name="check_all_jobs"><b>Select Total Event Counts For All Jobs</b></label>
                                </div>
                                {% for job in trace_model.jobs %}
                                    {% for process_name in trace_model.process_names[job]|natural_sort %}
                                        {% for id in ids %}
                                            {% if id.job == job and id.process_name == process_name and id.pid == "all" and id.tid == "all" %}
                                                {% if id in trace_model.selected_ids %}
                                                    {% set checked = "checked" %}
                                                {% else %}
                                                    {% set checked = "" %}
                                                {% endif %}
                                                {% set host_id = " / Host: " + id.process_name %}
                                                <div class="flex-row thread_filter" style="margin-left:0">
                                                    <div class="flex-column" style="width:55%;height:100%"><label><input class="job_checkbox" type="checkbox" {{checked}} id="{{job}}_all_all" name="{{id.label}}"><b>Event Count For Job:&nbsp{{id.job}}{{host_id}}</b></label></div>
                                                    <div class="flex-column" style="width:20%;height:100%"><span class="gradient_bar" value="{{id.max_percentage}}"></span></div>
                                                    <div class="flex-column" style="width:15%;height:100%"><span style="font-weight:bold" class="summed_percentage" value="{{id.total_percentage}}"></span><strong style="margin-left:6px;">{{id.total_percentage|round(2)|format_percentage}} %</strong></div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="flex-row">
                                <div class="flex-column" style="margin-left:12px;width:20%"><br><button style="margin:1px;" type="button" class="btn btn-basic btn-info" id="process_btn" name="process_btn" onclick="update_selected_processes(this)">Update Selected Processes</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
 </div>
<svg></svg>

{% endblock %}

{% block layoutfooter %}
<form action="{{url_for('clear_loaded_data')}}" method="post" id="clear_data_form">
    <div class="btn-group" data-toggle="buttons">
        <label style="margin:1px;margin-right:12px" class="btn btn-primary" onclick="clear_loaded_data()">
            <input type="radio" autocomplete="off"> Clear Results
        </label>
    </div>
    {{trace_model.layout.footer}}
</form>
{% endblock %}

{% block tail_js %}

<script type="text/javascript">

    var svg = document.querySelector('svg');
    var pt = svg.createSVGPoint();
    var selection_mode = "add-remove-process";

    function find_text(inputbox, id) {
        let filter = $(inputbox).prop("value");
        let svg_doc = document.getElementById(id);
        svg_doc.contentDocument.reset_search();
        if( filter.length > 0 )
        {
            svg_doc.contentDocument.search(filter);
        }
    }
    function find_function(direction) {
        let info = document.getElementById("flamegraph_info").innerHTML;
        let pattern = /[^\s]+/;
        filter = "";
        n = 0;
        let data_ok = false;
        if (pattern.test(info)) {
            filter = info.match(pattern)[0];
            pattern = /(.*)_\[\[call_([0-9]+)/;
            pattern.test(filter)
            if ( pattern.test(filter)) {
                match = pattern.exec(filter);
                filter = match[1];
                n = parseInt(match[2]);
                if( isNaN(n) ) {
                    return;
                }
            } else {
                n = 0;
                direction = "next";
            }
            data_ok = true;
        }
        if (!data_ok) {
            return;
        }
        let ref_id = document.getElementById("reference_id").value;
        pattern = /pid:(all|[0-9]+).*tid:(all|[0-9])+/;
        match = pattern.exec(ref_id);
        let pid = match[1];
        let tid = match[2];
        let timelines = document.getElementById("timelines");
        goto_url = "{{url_for('TraceView.find_function')}}";
        let vals = {"function_name": filter, "call_num": n, "direction": direction, "pid": pid, "tid": tid};
        let x = JSON.stringify(vals);
        let data = {json:x};
        showLoaders("Searching For " + filter);
        $.ajax({
            url:goto_url,
            contentType: 'application/json;charset=UTF-8',
            data:x,
            type: 'POST',
            success: function(response) {
                console.log(response);
                document.getElementById("flamegraph").data = response.flamegraph;
                document.getElementById("timelines").data = response.timelines;
                document.getElementById("flamegraph_info").innerHTML = response.function_name;
                let t1 = response.start;
                let t2 = response.stop;
                document.getElementById("time_range").innerHTML = "Start: " + t1.toString() + ", End: " + t2.toString();
                $('#cumulative_button').removeClass("active");
                $('#trace_button').addClass("active");
                $('#dynamic_rectangle').hide();
                hideLoaders();
            },
            error: function(error) {
                console.log(error);
            }
        });
    }
    function toggle_selection_mode(mode)
    {
        selection_mode = mode;
        if( selection_mode == "add-remove-process" ) {
            $('#selection_mode_text').prop("innerHTML", "Click on a process or select a range to update flamegraph");
        } else {
            $('#selection_mode_text').prop("innerHTML", "Select a range to zoom in");
        }
    }
    function toggle_flamegraph_mode(mode)
    {
        let vals = {"flamegraph_mode":mode};
        goto_url = "{{url_for('TraceView.update_flamegraph_mode')}}"
        let x = JSON.stringify(vals);
        let data = {json:x};
        showLoaders("Loading Selected Data");
        $.ajax({
            url:goto_url,
            contentType: 'application/json;charset=UTF-8',
            data:x,
            type: 'POST',
            success: function(response) {
                console.log(response);
                document.getElementById("flamegraph").data = response.flamegraph;
                if (mode == "trace") {
                    let t1 = response.start;
                    let t2 = response.stop;
                    document.getElementById("time_range").innerHTML = "Start: " + t1.toString() + ", End: " + t2.toString();
                    $('.trace_button').show();
                }
                document.getElementById("flamegraph_info").innerHTML = "";
                hideLoaders();
            },
            error: function(error) {
                console.log(error);
            }
        });
    }
    function check_thread_boxes(thisBox, match) {
        let boxes = document.getElementsByClassName("thread_checkbox");
	    let pc = 1000.0;
        let threshold = parseFloat($('#process_filter').prop('value'));
        for (let i=0; i<boxes.length; ++i) {
            if ( boxes[i].id.includes(match)) {
                if ($(boxes[i]).closest('.flex-row').find('.summed_percentage').length) {
                    pc = parseFloat($(boxes[i]).closest('.flex-row').find('.summed_percentage').attr('value'));
		        }
		        if (pc > threshold) {
                    boxes[i].checked = thisBox.checked;
                } else {
                    boxes[i].checked = false;
                }
            }
        }
    }
    function check_process_boxes(thisBox, match) {
        let boxes = document.getElementsByClassName("process_checkbox");
        for (let i=0; i<boxes.length; ++i) {
            if ( boxes[i].id.includes(match)) {
                boxes[i].checked = thisBox.checked;
            }
        }
    }
    function check_job_boxes(thisBox, match) {
        let boxes = document.getElementsByClassName("job_checkbox");
        for (let i=0; i<boxes.length; ++i) {
            if ( boxes[i].id.includes(match)) {
                boxes[i].checked = thisBox.checked;
            }
        }
    }
    function count_all_checkboxes() {
        $('.checkboxcount').each(function(){
           count_checkboxes($(this));
        });
    }
    function count_checkboxes(checkboxcount) {
        let n = 0;
        let m = 0;
        checkboxcount.closest('.counted_checklist').find('.counted_checkbox').each(function () {
            n++;
            if ($(this).is(':checked')) {
                m++;
            }
        });
        checkboxcount.prop('innerHTML','(' + m.toString() + ' / ' + n.toString() + ')');
    }
    function sum_checkbox_percentages() {
        $('.sum_checkbox_percentages').each(function () {
            sum_percentages($(this));
        });
    }
    function sum_percentages(checkboxpercentage) {
        let pc = 0.0;
        checkboxpercentage.closest('.counted_checklist').find('.summed_percentage').each(function () {
            let percentage = parseFloat($(this).attr('value'))
            pc += percentage
        });
        // Custom events result in over-counting
        if( pc >= 100.0 ) {
            pc = 100.0;
        }
        checkboxpercentage.prop('value',parseFloat(pc.toFixed(2)));
    }
    function fill_dynamic_text() {
        $('.dynamic_text').each(function() {
            let pc = $(this).prop('value');
            let x = parseFloat(pc);
            // Tidy up
            if( x >= 100.0 ) {
                pc.toFixed(0);
             }
            $(this).prop('innerHTML', pc + " %");
        });
    }
    function check_events() {
        let n = 0;
        let boxes = document.getElementsByClassName("thread_checkbox");
        for (let i=0; i<boxes.length; ++i) {
            if (boxes[i].checked) {
                n += 1;
            }
        }
        boxes = document.getElementsByClassName("process_checkbox");
        for (let i=0; i<boxes.length; ++i) {
            if (boxes[i].checked) {
                n += 1;
            }
        }
        boxes = document.getElementsByClassName("job_checkbox");
        for (let i=0; i<boxes.length; ++i) {
            if (boxes[i].checked) {
                n += 1;
            }
        }
        return n;
    }
    function add_flamegraph_events() {
        svg = document.getElementById("flamegraph");
        let subdoc = getSubDocument(svg)
        if (subdoc) {
            plot = $(subdoc).find('svg')
            addEvent(plot[0], "click", function(e) {
                if ( e.target && e.target.parentNode.nodeName == "g"){
                    wrap_flamegraph_onclick(e.target.parentNode);
                }
            });
        }
    }
    function wrap_flamegraph_onclick(e) {
        info_box = document.getElementById("flamegraph_info");
        let info;
        let children = e.childNodes;
        for (let i=0; i<children.length;i++) {
            if (children[i].tagName == "title") {
                info = children[i].firstChild.nodeValue;
            }
        }
        info_box.innerHTML = info;
    }
    // Get point in global SVG space
    function cursorPoint(evt){
      pt.x = evt.clientX; pt.y = evt.clientY;
      return pt;
    //  return pt.matrixTransform(svg.getScreenCTM().inverse());
    }
    //Variables
    var last_mousex;
    var last_mousey;
    var mousex;
    var mousey;
    var mousedown;
    var offsetx;
    var rect_top;
    var rect_height;
    function initialise_canvas() {
        let timelines = document.getElementById("timelines");
        let chart_canvas = getSubDocument(timelines);
        let rect = $(chart_canvas).find('#background_rect');
        last_mousex = last_mousey = 0;
        mousex = mousey = 0;
        mousedown = false;
        addEvent(rect[0], "mousedown", function(e) {
            let svg_object = document.getElementById("timelines");
            let svg_pos = $(svg_object).offset(); // svg plot elements have coordinates relative to plot object
            let canvas_container = document.getElementById("canvas_container");
            let canvas_pos = $(canvas_container).offset();  // box has coordinates relative to container
            rect_height = timelines.offsetHeight - 20;
            rect_top = timelines.offsetTop;
            offsetx = svg_pos.left - canvas_pos.left;
            $('#dynamic_rectangle').show();
            cursorPoint(e);
            last_mousex = parseInt(pt.x);
            last_mousey = parseInt(pt.y);
            mousedown = true;
        });
        addEvent(rect[0], 'mouseup', function(e) {
            mousedown = false;
            timeline_zoom();
        });
        addEvent(rect[0], 'mousemove', function(e) {
            cursorPoint(e);
            mousex = parseInt(pt.x);
            mousey = parseInt(pt.y);
            if(mousedown) {
                let x = last_mousex + offsetx;
                let y = rect_top;
                let width = mousex - last_mousex;
                let height = rect_height;
                $('#dynamic_rectangle').attr("x", x.toString());
                $('#dynamic_rectangle').attr("y", y.toString());
                $('#dynamic_rectangle').attr("width", width.toString());
                $('#dynamic_rectangle').attr("height", height.toString());
            }
            //debug
            $('#output').html('current: '+mousex+', '+mousey+'<br/>last: '+last_mousex+', '+last_mousey+'<br/>mousedown: '+mousedown);
        });
    }
    function timeline_zoom() {
        let minx = Number.MAX_VALUE;
        let maxx = -Number.MAX_VALUE;
        let xlower = Math.min(mousex, last_mousex);
        let xupper = Math.max(mousex, last_mousex);
        let zoom = false;
        let timelines = document.getElementById("timelines");
        let chart_canvas = getSubDocument(timelines);
        $(chart_canvas).find('.time_interval').each(function() {
            let pos = $(this).position();
            let x = pos.left;
            if ( x >= xlower + offsetx && x <= xupper + offsetx) {
                zoom = true;
                let time = $(this).attr("title");
                minx = Math.min(minx, parseFloat(time))
                maxx = Math.max(maxx, parseFloat(time))
            }
        });
        if ( zoom ) {
            vals = {"start": minx, "stop": maxx, "selection_mode": selection_mode};
            let x = JSON.stringify(vals);
            let data = {json:x};
            label = "Range"
            update_all_charts(label, x);
            if (selection_mode == "zoom") {
                $('#dynamic_rectangle').hide();
            }
        }
    }
    function reset_timelines() {
        let vals = {};
        goto_url = "{{url_for('TraceView.reset_timelines')}}"
        let x = JSON.stringify(vals);
        let data = {json:x};
        showLoaders("Loading Selected Data");
        $.ajax({
            url:goto_url,
            contentType: 'application/json;charset=UTF-8',
            data:x,
            type: 'POST',
            success: function(response) {
                console.log(response);
                document.getElementById("flamegraph").data = response.flamegraph;
                let t1 = response.start;
                let t2 = response.stop;
                document.getElementById("time_range").innerHTML = "";
                if( response.timelines != undefined ) {
                    document.getElementById("timelines").data = response.timelines;
                }
                $('#dynamic_rectangle').hide();
                hideLoaders();
            },
            error: function(error) {
                console.log(error);
            }
        });
    }
    function add_timeline_events(id) {
        initialise_canvas();
        let chart = document.getElementById(id);
        let subdoc = getSubDocument(chart);
        if( subdoc ) {
            $(subdoc).find('.func_g').each(function() {
                let rect = $(this).find('rect');
                addEvent(rect[0], "click", function() {
                    if( selection_mode == "add-remove-process") {
                        let description = $(this).closest('.func_g').find('title').html();
                        filter = /pid:\s*(all|[0-9]+).*tid:\s*(all|[0-9]+).*Start:\s*([\.0-9]+).*End:\s*([\.0-9]+)/g;
                        let match = filter.exec(description);
                        let pid = match[1];
                        let tid = match[2];
                        let vals = {"pid":pid, "tid":tid};
                        goto_url = "{{url_for('TraceView.update_flamegraph_ids')}}"
                        let x = JSON.stringify(vals);
                        let data = {json:x};
                        showLoaders("Loading Selected Data");
                        $.ajax({
                            url:goto_url,
                            contentType: 'application/json;charset=UTF-8',
                            data:x,
                            type: 'POST',
                            success: function(response) {
                                console.log(response);
                                document.getElementById("flamegraph").data = response.flamegraph;
                                document.getElementById("reference_id").value = response.reference_id;
                                hideLoaders();
                            },
                            error: function(error) {
                                console.log(error);
                            }
                        });
                    }
                });
            });
        }
    }
    function update_selected_processes(e) {
        let selected_processes = [];
        $('.thread_checkbox,.process_checkbox,.job_checkbox').each(function () {
            if ($(this).is(':checked')) {
                let name = $(this).attr('name');
                selected_processes.push(name);
            }
        });
        let vals = {"process_ids": selected_processes};
        let x = JSON.stringify(vals);
        label = "Selected Processes";
        update_all_charts(label, x);
    }
    function update_all_charts(label, x) {
        showLoaders("Loading Data For " + label);
        $.ajax({
            url:"{{url_for('TraceView.update_all_charts')}}",
            contentType: 'application/json;charset=UTF-8',
            data:x,
            type: 'POST',
            success: function(response) {
                console.log(response);
                let t1 = response.start;
                let t2 = response.stop;
                document.getElementById("time_range").innerHTML = "Start: " + t1.toString() + ", End: " + t2.toString();
                document.getElementById("flamegraph").data = response.flamegraph;
                document.getElementById("timelines").data = response.timelines;
                hideLoaders();
            },
            error: function(error) {
                console.log(error);
            }
        });
    }
    function filter_threads(inputbox) {
        let threshold = parseFloat($(inputbox).prop("value"));
        let boxes = document.getElementsByClassName("thread_checkbox");
        for (let i=0; i<boxes.length; ++i) {
            let pc = parseFloat($(boxes[i]).closest('.flex-row').find('.summed_percentage').attr('value'));
            if (pc < threshold) {
                boxes[i].checked = false;
                $(boxes[i]).closest('.flex-row').hide();
            } else {
                $(boxes[i]).closest('.flex-row').show();
            }
        }
        count_all_checkboxes();
    }
    function getSubDocument(embedding_element)
    {
        if (embedding_element.contentDocument)
        {
            return embedding_element.contentDocument;
        }
        else
        {
            let subdoc = null;
            try {
                subdoc = embedding_element.getSVGDocument();
            } catch(e) {}
            return subdoc;
        }
    }
    function addEvent(obj, evType, fn) {
        if (obj.addEventListener) {
            obj.addEventListener(evType, fn, false);
            return true;
        } else if (obj.attachEvent) {
            let r = obj.attachEvent("on" + evType, fn);
            return r;
        } else {
            alert("Handler could not be attached");
        }
    }
    window.onload = function()  {
        hideLoaders();

        $('input[type=checkbox]').each(function () {
            $(this).click(function () {
                count_all_checkboxes();
            });
        });
        count_all_checkboxes();
        sum_checkbox_percentages();
        insert_gradient_bars();
        fill_dynamic_text();
    }
    function toggleChevron(e) {
        $(e.target).prevUntil('.panel .panel-default')
            .find("i.indicator")
            .toggleClass('glyphicon-chevron-left glyphicon-chevron-down');
    }
    $('#accordion').on('hidden.bs.collapse', toggleChevron);
    $('#accordion').on('shown.bs.collapse', toggleChevron);
    function insert_gradient_bars() {
        $('.gradient_bar').each(function () {
            let pc = $(this).prop('value');
            // jQuery does not set the property 'value' to the initial value? Get the attribute 'value' instead
            if( typeof pc == 'undefined' ) {
               pc = $(this).attr('value');
            }
            let offset = Math.round(300 - 2*pc).toString()
            $(this).css("height","20px");
            $(this).css("width", Math.round(pc).toString() + "%");
            $(this).css("background","linear-gradient(to right, green, red " + offset + "%");
        });
    }
    function showLoaders(message) {
        $('.loader').each(function() {
            $(this).prop("innerHTML", message);
            $(this).show();
        });
    }
    function hideLoaders() {
        setTimeout(hideLoaderTimeout, 2500);
        $('.loader').each(function() {
            $(this).prop('innerHTML', "Data Update Complete");
        });
    }
    function hideLoaderTimeout(loader) {
        $('.loader').each(function() {
            $(this).hide();
        });
    }
    function clear_loaded_data() {
        $("#clear_data_form").submit();
    }

</script>

{% endblock %}